{
    "collab_server" : "",
    "contents" : "library(shiny)\nsource(\"global.R\")\n\nshinyServer(\n  function(input, output) {\n  \n    \n    output$box <- renderTable({\n      #select price table by weekday\n      if (input$weekday == 7){\n        data <- boxSun\n      } else if (input$weekday == 5){\n        data <- boxFri\n      } else if (input$weekday == 6){\n        data <- boxSat\n      } else {\n        data <- boxMTWT\n      }\n      #select boxsize by numbers of people\n      if (input$range == 1 | input$range == 2|input$range == 3){\n        boxprice = data[,2]\n        boxn <- colnames(data[2])\n      } else if (input$range == 4 |input$range ==5 | input$range ==6){\n        boxprice = data[,3]\n        boxn <- colnames(data[3])\n      } else if (input$range == 7 |input$range ==8 | input$range ==9){\n        boxprice = data[,4]\n        boxn <- colnames(data[4])\n      } else if (input$range == 10 |input$range ==11 | input$range ==12){\n        boxprice = data[,5]\n        boxn <- colnames(data[5])\n      } else if (input$range == 13 |input$range ==14 | input$range ==15){\n        boxprice = data[,6]\n        boxn <- colnames(data[6])\n      } else if (input$range == 16 |input$range ==17 | input$range ==18){\n        boxprice = data[,8]\n        boxn <- colnames(data[8])\n      } else {\n        boxprice = data[,9]\n        boxn <- colnames(data[9])\n      }\n      branchname <- as.data.frame(boxMTWT[,1])\n      boxprice <- as.data.frame(boxprice)\n      boxprice = cbind(boxprice, branchname)\n      colnames(boxprice)[2] <- \"branch\"\n      \n      start <- as.numeric(input$start)\n      start <- start + 10\n      end   <- as.numeric(input$end)\n      end   <- end + 10\n    \n      #for (i in 1:ncol(boxprice))\n      #{\n      #  boxprice = boxprice[ !is.na(boxprice[,i]),] \n      #  colnames(boxprice)[2] <- \"branch\"\n      #}\n        \n      if (start < end){\n        timeprice = data[,start:end]\n        timeprice$trsum <- rowSums(timeprice)\n        timeprice = cbind(boxprice,timeprice,data[,34:36])\n        for (j in 1:ncol(timeprice)) {\n          timeprice = timeprice [ !is.na(timeprice[,j]),]\n        }\n      } else if (start > end){\n        temps = data[,start:33]\n        temps = as.data.frame(temps)\n        tempe = data[,10:end] \n        tempe = as.data.frame(tempe)\n        timeprice = cbind(temps,tempe)\n        timeprice$trsum <- rowSums(timeprice)\n        timeprice = cbind(boxprice,timeprice,data[,34:36])\n        for (j in 1:ncol(timeprice)){\n          timeprice = timeprice [ !is.na(timeprice[,j]),]\n        }\n      } else {\n        timeprice = data[,10:33]\n        timeprice$trsum <- rowSums(timeprice)\n        timeprice = as.data.frame(timeprice)%>%\n          cbind(boxprice,.)\n        timeprice = cbind(timeprice,data[,34:36])\n        timeprice = na.omit(timeprice)\n      }\n      #calculation\n    \n      temptable <- mutate(timeprice, boxtotal = boxprice*trsum) \n      temptable <- mutate(temptable, boxavg = boxtotal/input$range)\n      temptable$whichbox <- boxn\n      ktv <- as.data.frame(temptable$store)\n        colnames(ktv) <- \"KTV\"\n      branch <- as.data.frame(temptable$branch)\n        colnames(branch) <- \"分店\"\n      whichb <- as.data.frame(temptable$whichbox)\n        colnames(whichb) <- \"建議包廂類型\"\n      boxa <- as.data.frame(temptable$boxavg)\n        colnames(boxa) <- \"boxavg\"\n      phone <- as.data.frame(temptable$phone)\n        colnames(phone) <- \"電話\"\n      address <- as.data.frame(temptable$address)\n        colnames(address) <- \"地址\"\n      temptable2 <- cbind(ktv, branch,whichb,boxa)%>%\n        mutate(.,avgn = boxavg/input$range)\n      \n      \n      #discount\n      #dd at line 7\n      dd <- paste(input$discount,sep=\"\",collapse=\"\")\n      if (grepl(3,dd)==T & grepl(4,dd)==F){\n        discounthld = 0.9\n        discountcg = 1\n      } else if (grepl(3,dd)==F & grepl(4,dd)==T){\n        discounthld = 1\n        discountcg = 0.95\n      } else if(grepl(3,dd)==T & grepl(4,dd)==T){\n        discounthld = 0.9\n        discountcg = 0.95\n      } else{\n        discounthld = 1\n        discountcg = 1\n      }\n      \n        \n      for(i in 1:length(temptable2$boxavg)){\n        if (temptable2$KTV[i] == \"好樂迪\"){\n          temptable2$avgn[i] = (temptable2$avgn[i]*discounthld + 100)*1.1\n        } else if (temptable2$KTV[i] == \"錢櫃\"){\n          temptable2$avgn[i] = (temptable2$avgn[i]*discountcg + 99)*1.1\n        } else {\n          if (input$weekday == 1 | 2 | 3 | 4 ){\n            dc <- 0.8\n          } else{\n            dc <- 1\n          }\n          temptable2$avgn[i] = (temptable2$avgn[i]*dc + 99)*1.1\n        }\n      }\n      a <- temptable2[,1:3]\n      b <- as.data.frame(temptable2$avgn)\n      colnames(b) <- \"每人平均\"\n      #c <- temptable2[,5:6]\n      finaltable <- cbind(a,b) %>%\n        arrange(., 每人平均)\n      #colnames(finaltable[4]) <- \"每人平均(元)\"\n      finaltable\n      \n    })\n      output$boxname <- renderTable({\n        boxName\n      })\n      \n      \n      output$head <- renderTable({\n        \n          #select price table by weekday & student ID card\n        dd <- paste(input$discount,sep=\"\",collapse=\"\")\n        \n        if (grepl(2,dd)==T){\n          if (input$weekday == 7){\n            datah <- headSunS\n          } else if (input$weekday == 5){\n            datah <- headFriS\n          } else if (input$weekday == 6){\n            datah <- headSatS\n          } else {\n            datah <- headMTWTS\n          }\n        }else {\n          if (input$weekday == 7){\n            datah <- headSun\n          } else if (input$weekday == 5){\n            datah <- headFri\n          } else if (input$weekday == 6){\n            datah <- headSat\n          } else {\n            datah <- headMTWT\n          }\n        }\n        starth <- as.numeric(input$start)\n        endh   <- as.numeric(input$end)\n        \n        if (starth >=6 & starth <11){\n          head <- datah[,2:5]\n        } else if (starth >=11 & starth <15){\n          head <- datah[,6:9]\n        } else if (starth >=15 & starth <19){\n          head <- datah[,10:13]\n        } else if (starth >=19 & starth <23) {\n          head <- datah[,14:17]\n        } else {\n          head <- datah[,18:21]\n        }\n        head <- cbind(datah[,22],datah[,1],head)\n        for (i in 1:ncol(head)){\n          head = head[ !is.na(head[,i]),]\n        }\n        temphead <- as.data.frame(head)\n        \n        if (grepl(3,dd)==T & grepl(4,dd)==F){\n          discounthld = 0.9\n          discountcg = 1\n        } else if (grepl(3,dd)==F & grepl(4,dd)==T){\n          discounthld = 1\n          discountcg = 0.95\n        } else if(grepl(3,dd)==T & grepl(4,dd)==T){\n          discounthld = 0.9\n          discountcg = 0.95\n        } else{\n          discounthld = 1\n          discountcg = 1\n        }\n        \n        #for (i in 1:length(temphead[,5])){\n         # if (starth < endh){\n          #  if (endh - starth > temphead[i,5]){\n          #    temphead[i,4] = temphead[i,4] + temphead[i,6]*(endh - starth)\n          #  } else{\n          #    temphead[i,4] = temphead[i,4]\n          #  }\n          #} else{\n          #  if (24 - (starth - endh) > temphead[i,5]){\n          #    temphead[i,4] = temphead[i,4] + temphead[i,6]*(24-(starth - endh))\n          #  } else {\n          #    temphead[i,4] = temphead[i,4]\n          #  }\n          #}\n        #}\n        \n        for(i in 1:length(temphead[,1])){\n          if (temphead[i,1]==\"好樂迪\"){\n            temphead[i,4] <- (temphead[i,4]*discounthld+100)*1.1\n          } else if (temphead[i,1] == \"錢櫃\"){\n            temphead[i,4] <- (temphead[i,4]*discouncg+100)*1.1\n          } else{\n            temphead[i,4] <- (temphead[i,4]+100)*1.1\n          }\n         } \n        names(temphead) <- c(\"KTV\",\"分店\",\"適用入場時段\",\"每人價格\",\"歡唱時數\",\"續唱價格(每小時)\")\n        temphead <- arrange(temphead, 每人價格)\n        temphead\n      })\n      \n      output$info <- renderTable({\n        \n        infotable <- boxMTWT\n        if (input$KTV == 2){\n          infotable = infotable[1:10,]\n        } else if (input$KTV ==3){\n          infotable = infotable[14:19,]\n        } else if (input$KTV == 4){\n          infotable = infotable[11:13,]\n        } else {\n          infotable = infotable\n        }\n        storektv <-  as.data.frame(infotable[,34])\n        storebranch <-  as.data.frame(infotable[,1])\n        storephone <- as.data.frame(infotable[,36])\n        storeaddress <- as.data.frame(infotable[,35])\n        infotable = cbind(storektv, storebranch, storephone, storeaddress)\n        names(infotable) <- c(\"KTV\", \"分店\", \"電話\", \"地址\")\n        infotable\n      })\n  }\n)",
    "created" : 1483260023655.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "146|37|148|6|\n241|34|260|6|\n",
    "hash" : "2123758427",
    "id" : "480E59A9",
    "lastKnownWriteTime" : 1483960722,
    "last_content_update" : 1483960722558,
    "path" : "C:/Users/acer/Desktop/KTVcaculator/testKTVcalculator/server.R",
    "project_path" : "server.R",
    "properties" : {
        "source_window_id" : ""
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}